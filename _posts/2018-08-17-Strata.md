---
layout: page
title: Strata -- A Cross Media File System
tags: [New Hardware, File System]
excerpt_separator: <!--more-->
typora-root-url: ../
---



## Strata: A Cross Media File System

### 0x00 å¼•è¨€

  è¿™ç¯‡Paperæ˜¯SOSP'17ä¸Šé¢çš„ä¸€ç¯‡å…³äºè·¨ä»‹è´¨æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ç« ã€‚ç°åœ¨çš„æŒä¹…åŒ–çš„å­˜å‚¨ä»‹è´¨æœ‰NVMã€SSDå’Œä¼ ç»Ÿçš„HDDï¼Œå®ƒä»¬æœ‰ç€å„è‡ªä¸åŒçš„ç‰¹ç‚¹ã€‚è€Œç°åœ¨çš„å¾ˆå¤šæ–‡ä»¶ç³»ç»Ÿéƒ½æ˜¯é’ˆå¯¹å…¶ä¸­ä¸€ç§å­˜å‚¨ä»‹è´¨è¿›è¡Œä¼˜åŒ–ï¼Œæ¯”å¦‚NOVAä¹‹äºNVMã€F2FSé¢å‘SSDå·²ç»ext4å¯¹HDDã€‚è¿™ç¯‡Paperåˆ™æå‡ºåˆ©ç”¨ç±»ä¼¼LSM-treeçš„æ–¹æ³•ï¼Œå°†æ–‡ä»¶ç³»ç»Ÿç³»ç»Ÿåšæˆå±‚æ¬¡åŒ–çš„ç»“æ„ï¼Œåˆ©ç”¨å¥½ä¸åŒä»‹è´¨çš„ä¸åŒçš„ç‰¹ç‚¹ã€‚

```
... Strata using a 3-layer storage hierarchy of emulated NVM, a flash-based SSD, and a high-density HDD. Strata has 20-30% better latency and throughput, across several unmodified applications, compared to file systems purpose-built for each layer, while providing synchronous and unified access to the entire storage hierarchy. Finally, Strata achieves up to 2.8Ã— better throughput than a block-based 2-layer cache provided by Linuxâ€™s logical volume manager.
```

Strata(Stratumï¼Œåœ°å±‚ã€é˜¶å±‚)ä¸­å‡ºç°çš„ä¸€äº›æ¦‚å¿µï¼Œ

![strata-concepts](/assets/img/strata-concepts.png)

### 0x01 åŸºæœ¬è®¾è®¡

 Strataçš„åŸºæœ¬ç»“æ„å¦‚ä¸‹å›¾ã€‚Strataçš„å‡ ä¸ªè®¾è®¡è¦ç‚¹ï¼š

* Strataçš„åŸºæœ¬æ¶æ„ç±»ä¼¼ä¸LSM-treeã€‚Strataçš„å†™å…¥æ“ä½œå¼€å§‹æ—¶ä½¿ç”¨loggingçš„æ–¹å¼å†™å…¥åˆ°NVMä¸Šé¢ï¼ŒLogçš„æ–¹å¼åŠ ä¸ŠNVMçš„ç¡¬ä»¶ç‰¹æ€§ï¼Œå¯¹å°æ•°æ®å†™å…¥ã€ä¸€è‡´æ€§ã€Crashæ¢å¤ä»¥åŠæ“ä½œåŸå­æ€§éƒ½æœ‰åˆ©ã€‚ä»¥è¿™æ ·çš„æ–¹å¼å†™å…¥åˆ°NVMé‡Œé¢æœ‰åˆ©äºå†™ä½†æ˜¯ä¸åˆ©äºæŸ¥æ‰¾å’Œè¯»æ“ä½œã€‚Strataåœ¨åˆé€‚çš„æ—¶å€™å°†logâ€œæ¶ˆåŒ–â€åˆ°ä¸‹ä¸€å±‚çš„å­˜å‚¨è®¾å¤‡ä¸Šï¼Œåœ¨è¿™é‡Œçš„å­˜å‚¨æ ¼å¼æ˜¯ä¸ºè¯»å–ä¼˜åŒ–çš„ã€‚
* Log at user-level, digest in the kernelï¼ŒNVMçš„é«˜æ€§èƒ½ä½¿ç”¨ä¼ ç»Ÿçš„syscallçš„æ–¹å¼ä¼šé€ æˆå¾ˆå¤§çš„overheadã€‚Strataä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½¿ç”¨äº†user-levelçš„å®ç°çš„æ–¹å¼ã€‚è¿™ä¸ªæ€è·¯ä¹Ÿå’Œå¾ˆå¤šçš„user-levelç½‘ç»œæ ˆå®ç°çš„æ€è·¯ä¸€è‡´ã€‚è€Œdigestæ“ä½œåˆ™ä¼šåœ¨kernelä¸­å¼‚æ­¥å¹¶è¡Œåœ°è¿›è¡Œã€‚
* Sequential, aligned writesï¼Œdigestçš„å·¥ä½œæ–¹å¼ä¹Ÿæ˜¯çš„å†™å…¥åˆ°ä¸‹ä¸€å±‚çº§çš„å­˜å‚¨ä»‹è´¨ä¸Šæ—¶æ•°æ®çš„æ˜¯å¤§å—çš„ã€‚è€Œä¸”å¯ä»¥åœ¨digestæ“ä½œæ˜¯è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œåˆå¹¶å†™æ“ä½œä»¥åŠé™ä½ç¢ç‰‡ã€‚
* Use hardware-assisted protectionï¼ŒLogåœ¨user-levelå®Œæˆï¼ŒStrataå€ŸåŠ©ç¡¬ä»¶è™šæ‹ŸåŒ–çš„æŠ€æœ¯æ¥ä¿éšœå­å•Šbypass-kernelçš„æƒ…å†µä¸‹çš„å®‰å…¨æ€§ï¼›
* Strateçš„å…ƒæ•°æ®å’Œä¸€èˆ¬çš„æ–‡ä»¶ç³»ç»Ÿæ²¡æœ‰ä»€ä¹ˆå·®åˆ«ï¼Œä¹Ÿæ˜¯Superblockï¼ŒInodesï¼Œç›®å½•ä»¥åŠç©ºé—²ç©ºé—´ç®¡ç†çš„ç»“æ„ç»„æˆçš„ã€‚è€Œä¸”Strateå¯ä»¥å°†å¤šä¸ªå­˜å‚¨è®¾å¤‡å®ä¾‹å½“ä½œä¸€ä¸ªé€»è¾‘ä¸Šçš„è®¾å¤‡ä½¿ç”¨ã€‚

![strata-arch](/assets/img/strata-arch.png)

### 0x02 å…¶å®ƒä¸€äº›

#### LibFS

 LibFSçš„å‡ ç‚¹è®¾è®¡ï¼š

* å¿«é€ŸåŒæ­¥æŒä¹…åŒ–æ“ä½œï¼ŒStrateä½¿ç”¨ç›´æ¥å†™å…¥åˆ°NVMçš„æ–¹å¼ï¼Œä¸ä½¿ç”¨è¯´æ˜Page Caheä¹‹ç±»çš„ï¼Œé¿å…äº†è¿™ä¸ªå¸¦æ¥çš„ä¸€äº›å¼€é”€ã€‚é€šè¿‡ç®€å•çš„åŒæ­¥çš„æŒä¹…åŒ–çš„è¯­ä¹‰ï¼Œä¹Ÿä½¿å¾—åº”ç”¨çš„ä¸€äº›æ“ä½œå˜å¾—ç®€å•(æƒ³æƒ³åœ¨ç»å¸¸å‡ºç°çš„fsyncæ“ä½œ)ã€‚å¦å¤–ï¼ŒStrateçš„logä¸ºä¸€ç§operation logï¼Œé™ä½äº†ä¸€äº›å†™å…¥çš„æ•°æ®çš„é‡ã€‚Strateè¿˜ä½¿å¾—logæ˜¯å¹‚ç­‰çš„ã€‚
* Crashä¸€è‡´çš„loggingï¼ŒStrataä½¿ç”¨Strata transactionçš„æ–¹å¼æ¥ä¿æŒæ“ä½œçš„ACIDçš„ç‰¹æ€§ã€‚å¦å¤–ï¼ŒStrataçš„logä¸­åŒ…å«äº†è¶³å¤Ÿçš„æƒ³è±¡ï¼Œè€Œä¸”logæ“ä½œä¿éšœäº†æ“ä½œåº”ç”¨çš„é¡ºåºï¼Œä¹Ÿä½¿å¾—ä¿è¯æ–‡ä»¶ç³»ç»Ÿä¸€è‡´æ€§å˜å¾—ç®€å•ï¼›
* Digestæ“ä½œå’ŒGCï¼Œåœ¨logçš„é‡è¾¾åˆ°ä¸€ä¸ªé˜ˆå€¼çš„æ—¶å€™ï¼Œä¼šè¯·æ±‚KernelFSè¿›è¡Œdigestæ“ä½œã€‚åœ¨è¿™æ¶æè¿‡ç¨‹ä¸­å°±å¯ä»¥è¿›è¡ŒGCæ“ä½œã€‚
* å¿«è¯»è¯»å–ï¼ŒLibFSä¼šå°†ä¸€äº›æ•°æ®å’Œå…ƒæ•°æ®Cacheåœ¨å†…å­˜ä¸­ã€‚Cacheçš„æ•°æ®åªä¼šæ¥è‡ªSSDæˆ–è€…æ˜¯HDDã€‚



#### KernelFS

KernelFSçš„å‡ ç‚¹è®¾è®¡ï¼š

* Digestæ“ä½œï¼ŒKernelFSçš„Digestæ“ä½œä¼šå°†LibFSç”Ÿæˆçš„operation logè½¬åŒ–ä¸ºæ¯ä¸€ä¸ªæ–‡ä»¶ä¸€ä¸ªçš„extent treeã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¯ä»¥è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œåˆå¹¶å†™æ“ä½œï¼Œå‡å°‘ç¢ç‰‡åŒ–ç­‰ã€‚ç”±äºDigestæ“ä½œæ˜¯å¤§å—çš„å†™å…¥ï¼Œè€Œä¸”åœ¨ä¸€å®šçš„æƒ…å†µä¸‹ï¼Œå†™å…¥çš„æ•°æ®æ˜¯å¯çŸ¥çš„ï¼Œè¿™æ ·ç»™KernelFSå°†æ•°æ®å†™å…¥ä¸‹ä¸€å±‚çº§çš„æ—¶å€™æ¯”è¾ƒå¤§çš„ä¼˜åŒ–çš„ç©ºé—´ï¼›

* Data access pattern interfaceï¼Œç”±äºStrataæ˜¯ä¸€ç§å±‚çº§å¼çš„ç»“æ„ï¼Œæ‰€ä»¥KernelFSå¾—ç»´æŒå¤šä¸ªçš„LRUçš„listç”¨äºæ•°æ®è¿ç§»ï¼Œè¿™ä¸ªlistçš„æ•°é‡æ ¹æ®å±‚çº§çš„æ•°é‡ç¡®å®šã€‚è¿™ä¸ªæ˜¯2ï¼Œåˆ†åˆ«æ˜¯NVMåˆ°SSDï¼ŒSSDåˆ°HDDã€‚å¦å¤–ä¸€äº›è®¿é—®çš„ä¿¡æ¯åœ¨LibFSä¸­ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦LibFSç›¸å…³çš„é…åˆï¼Œ

  ```
   LibFS can submit access information as frequently as it wishes via a system call. KernelFS transforms the LibFS-provided LRU lists into coarser-grained lists for storage layers that have larger block sizes (e.g., 1MB blocks for NVM and 4MB for SSD).
  ```

* Data migrationï¼Œæ•°æ®è¿ç§»çš„åšæ³•ç±»ä¼¼äºLSM-treeåˆå¹¶çš„æ“ä½œï¼Œä¸ºäº†æé«˜è¿ç§»çš„æ•ˆç‡å’Œå‡å°‘ç¢ç‰‡è¯ï¼Œè¿ç§»åˆ°SSDçš„æ—¶å€™ä¸€æ¬¡è¿ç§»æ•°ç™¾MBçš„æ•°æ®ï¼Œè¿ç§»åˆ°HDDçš„æ—¶å€™ä¸ºæ•°GBçš„æ•°æ®ã€‚



#### å±€é™

åœ¨ç›®å‰çš„Strataçš„å®ç°ä¸­å­˜åœ¨çš„ä¸€äº›é—®é¢˜orå±€é™ï¼š

* Kernelï¼ŒLibFS å’Œ KernelFSç›®å‰é€šä¿¡çš„æ–¹å¼æ˜¯é€šè¿‡Socketï¼Œè¿™ä¸ªåœ¨ä¸€äº›æƒ…å†µä¸‹å¯èƒ½é€ æˆæ¯”è¾ƒå¤§çš„overheadã€‚ä½†æ˜¯Paperä¸­åˆè®¤ä¸ºè¿™ä¸ªå½±å“æ¯”è¾ƒå°ï¼›

* Leasesï¼Œå³Sharing (leases)ï¼Œè¿™ä¸ªåŠŸèƒ½è¿˜æ²¡æœ‰å®Œå…¨å®ç°ï¼Œç°åœ¨è¿˜å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œ

  ```
   To guarantee strict ordering and synchronous persistence, LibFS must first acquire a lease in order to create the lock file and relinquish the lease and perform a digest after the lock file is unlinked. Strata achieves a throughput of 10,400 updates/s, 4.3Ã— slower than EXT4-DAX and 1.7Ã— slower than NOVA. 
  ```

* Memory mapped filesï¼Œæ²¡æœ‰å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚ç›®å‰è¦åœ¨Strataä¸­å®ç°å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚å°æ•°æ®çš„éšæœºå†™å…¥æ“ä½œçš„å†™å…¥æ”¾å¤§çš„é—®é¢˜ï¼›

* Fault toleranceï¼Œç›®å‰è¿˜æ²¡æœ‰å®¹å¿å­˜å‚¨è®¾å¤‡æ•…éšœçš„æœºåˆ¶ã€‚



### 0x03 è¯„ä¼°

å…·ä½“çš„ä¿¡æ¯å¯ä»¥å‚çœ‹[1]ï¼Œä»ä¸‹é¢çš„è¿™ä¸ªå›¾çœ‹å‡ºæ¥å°æ–‡ä»¶çš„ä¼˜åŒ–æ‰æ˜¯é‡ç‚¹é¸­ğŸ¦†ã€‚

![strata-perf](/assets/img/strata-perf.png)



### å‚è€ƒ

1. Strata: A Cross Media File System, SOSP'17.